From f194ed97f412cb968664a46737c9b60a353ae992 Mon Sep 17 00:00:00 2001
From: Vlad Zagorodniy <vladzzag@gmail.com>
Date: Mon, 26 Mar 2018 16:00:19 +0300
Subject: [PATCH 7/7] [effects] Use multisampling

---
 effects/backgroundcontrast/contrast.cpp   |  7 +-
 effects/blur/blur.cpp                     | 15 ++--
 effects/coverswitch/coverswitch.cpp       |  4 ++
 effects/coverswitch/coverswitch.h         |  1 +
 effects/coverswitch/coverswitch.kcfg      |  3 +
 effects/coverswitch/coverswitch_config.ui | 11 ++-
 effects/cube/cube.cpp                     |  5 +-
 effects/cube/cube.h                       |  1 +
 effects/cube/cube.kcfg                    |  3 +
 effects/cube/cube_config.ui               | 38 +++++-----
 effects/cube/cubeslide.cpp                |  4 ++
 effects/cube/cubeslide.h                  |  1 +
 effects/cube/cubeslide.kcfg               |  3 +
 effects/cube/cubeslide_config.ui          | 11 ++-
 effects/flipswitch/flipswitch.cpp         |  4 ++
 effects/flipswitch/flipswitch.h           |  1 +
 effects/flipswitch/flipswitch.kcfg        |  3 +
 effects/flipswitch/flipswitch_config.ui   | 32 +++++----
 effects/magiclamp/magiclamp.cpp           |  7 +-
 effects/magiclamp/magiclamp.h             |  1 +
 effects/magiclamp/magiclamp.kcfg          |  3 +
 effects/magiclamp/magiclamp_config.ui     | 86 +++++++++++++++--------
 libkwineffects/kwineffects.h              |  6 +-
 23 files changed, 166 insertions(+), 84 deletions(-)

diff --git a/effects/backgroundcontrast/contrast.cpp b/effects/backgroundcontrast/contrast.cpp
index f920fcd88..5247d83b8 100644
--- a/effects/backgroundcontrast/contrast.cpp
+++ b/effects/backgroundcontrast/contrast.cpp
@@ -447,11 +447,10 @@ void ContrastEffect::doContrast(EffectWindow *w, const QRegion& shape, const QRe
     GLTexture scratch(GL_RGBA8, r.width() * scale, r.height() * scale);
     scratch.setFilter(GL_LINEAR);
     scratch.setWrapMode(GL_CLAMP_TO_EDGE);
-    scratch.bind();
 
-    const QRect sg = GLRenderTarget::virtualScreenGeometry();
-    glCopyTexSubImage2D(GL_TEXTURE_2D, 0, 0, 0, (r.x() - sg.x()) * scale, (sg.height() - sg.y() - r.y() - r.height()) * scale,
-                        scratch.width(), scratch.height());
+    GLRenderTarget scratchTarget(scratch);
+    scratchTarget.blitFromFramebuffer(r);
+    scratch.bind();
 
     // Draw the texture on the offscreen framebuffer object, while blurring it horizontally
 
diff --git a/effects/blur/blur.cpp b/effects/blur/blur.cpp
index cc4734e60..4985317f8 100644
--- a/effects/blur/blur.cpp
+++ b/effects/blur/blur.cpp
@@ -624,19 +624,12 @@ void BlurEffect::doBlur(const QRegion& shape, const QRect& screen, const float o
      * We want to avoid this on panels, because it looks really weird and ugly
      * when maximized windows or windows near the panel affect the dock blur.
      */
-    isDock ? m_renderTextures.last().bind() : m_renderTextures[0].bind();
+    GLTexture& copyTexture = isDock ? m_renderTextures.last() : m_renderTextures.first();
 
     QRect copyRect = expandedBlurRegion.boundingRect() & screen;
-    glCopyTexSubImage2D(
-        GL_TEXTURE_2D,
-        0,
-        copyRect.x(),
-        effects->virtualScreenSize().height() - copyRect.y() - copyRect.height(),
-        copyRect.x(),
-        effects->virtualScreenSize().height() - copyRect.y() - copyRect.height(),
-        copyRect.width(),
-        copyRect.height()
-    );
+    GLRenderTarget copyTarget(copyTexture);
+    copyTarget.blitFromFramebuffer(copyRect, copyRect);
+    copyTexture.bind();
 
     GLRenderTarget::pushRenderTargets(m_renderTargetStack);
     int blurRectCount = expandedBlurRegion.rectCount() * 6;
diff --git a/effects/coverswitch/coverswitch.cpp b/effects/coverswitch/coverswitch.cpp
index 463e13ec4..83bf0edcc 100644
--- a/effects/coverswitch/coverswitch.cpp
+++ b/effects/coverswitch/coverswitch.cpp
@@ -93,6 +93,7 @@ void CoverSwitchEffect::reconfigure(ReconfigureFlags)
     animateStart      = CoverSwitchConfig::animateStart();
     animateStop       = CoverSwitchConfig::animateStop();
     reflection        = CoverSwitchConfig::reflection();
+    multisampling     = CoverSwitchConfig::multisampling();
     windowTitle       = CoverSwitchConfig::windowTitle();
     zPosition         = CoverSwitchConfig::zPosition();
     timeLine.setCurveShape(QTimeLine::EaseInOutCurve);
@@ -119,6 +120,9 @@ void CoverSwitchEffect::prePaintScreen(ScreenPrePaintData& data, int time)
 {
     if (mActivated || stop || stopRequested) {
         data.mask |= Effect::PAINT_SCREEN_WITH_TRANSFORMED_WINDOWS;
+        if (multisampling) {
+            data.mask |= Effect::PAINT_SCREEN_MULTISAMPLE;
+        }
         if (animation || start || stop) {
             timeLine.setCurrentTime(timeLine.currentTime() + time);
         }
diff --git a/effects/coverswitch/coverswitch.h b/effects/coverswitch/coverswitch.h
index 320c0521d..9b1e3482a 100644
--- a/effects/coverswitch/coverswitch.h
+++ b/effects/coverswitch/coverswitch.h
@@ -129,6 +129,7 @@ private:
     bool start;
     bool stop;
     bool reflection;
+    bool multisampling;
     float mirrorColor[2][4];
     bool windowTitle;
     int animationDuration;
diff --git a/effects/coverswitch/coverswitch.kcfg b/effects/coverswitch/coverswitch.kcfg
index 77db6d29b..bd3e0ab3a 100644
--- a/effects/coverswitch/coverswitch.kcfg
+++ b/effects/coverswitch/coverswitch.kcfg
@@ -38,5 +38,8 @@
         <entry name="TabBoxAlternative" type="Bool">
             <default>false</default>
         </entry>
+        <entry name="Multisampling" type="Bool">
+            <default>true</default>
+        </entry>
     </group>
 </kcfg>
diff --git a/effects/coverswitch/coverswitch_config.ui b/effects/coverswitch/coverswitch_config.ui
index 982caf6d1..0fb6340f4 100644
--- a/effects/coverswitch/coverswitch_config.ui
+++ b/effects/coverswitch/coverswitch_config.ui
@@ -7,7 +7,7 @@
     <x>0</x>
     <y>0</y>
     <width>453</width>
-    <height>270</height>
+    <height>289</height>
    </rect>
   </property>
   <layout class="QVBoxLayout" name="verticalLayout_5">
@@ -21,6 +21,13 @@
      </property>
     </widget>
    </item>
+   <item>
+    <widget class="QCheckBox" name="kcfg_Multisampling">
+     <property name="text">
+      <string>Use multisampling</string>
+     </property>
+    </widget>
+   </item>
    <item>
     <layout class="QVBoxLayout" name="verticalLayout_4">
      <item>
@@ -136,7 +143,7 @@
          <item row="0" column="0">
           <widget class="QLabel" name="label_3">
            <property name="text">
-            <string>Animation duration:</string>
+            <string>A&amp;nimation duration:</string>
            </property>
            <property name="alignment">
             <set>Qt::AlignRight|Qt::AlignTrailing|Qt::AlignVCenter</set>
diff --git a/effects/cube/cube.cpp b/effects/cube/cube.cpp
index 3e924511d..af29597bf 100644
--- a/effects/cube/cube.cpp
+++ b/effects/cube/cube.cpp
@@ -166,6 +166,7 @@ void CubeEffect::reconfigure(ReconfigureFlags)
     backgroundColor = CubeConfig::backgroundColor();
     capColor = CubeConfig::capColor();
     paintCaps = CubeConfig::caps();
+    multisampling = CubeConfig::multisampling();
     closeOnMouseRelease = CubeConfig::closeOnMouseRelease();
     zPosition = CubeConfig::zPosition();
 
@@ -342,7 +343,9 @@ void CubeEffect::prePaintScreen(ScreenPrePaintData& data, int time)
 {
     if (activated) {
         data.mask |= PAINT_SCREEN_TRANSFORMED | Effect::PAINT_SCREEN_WITH_TRANSFORMED_WINDOWS | PAINT_SCREEN_BACKGROUND_FIRST;
-
+        if (multisampling) {
+            data.mask |= PAINT_SCREEN_MULTISAMPLE;
+        }
         if (rotating || start || stop) {
             timeLine.setCurrentTime(timeLine.currentTime() + time);
             rotateCube();
diff --git a/effects/cube/cube.h b/effects/cube/cube.h
index 0de8ad53e..c53d9215c 100644
--- a/effects/cube/cube.h
+++ b/effects/cube/cube.h
@@ -189,6 +189,7 @@ private:
     bool verticalRotating;
     bool desktopChangedWhileRotating;
     bool paintCaps;
+    bool multisampling;
     QTimeLine timeLine;
     QTimeLine verticalTimeLine;
     RotationDirection rotationDirection;
diff --git a/effects/cube/cube.kcfg b/effects/cube/cube.kcfg
index f0c5fda7e..1b563465d 100644
--- a/effects/cube/cube.kcfg
+++ b/effects/cube/cube.kcfg
@@ -64,5 +64,8 @@
         <entry name="ZOrdering" type="Bool">
             <default>false</default>
         </entry>
+        <entry name="Multisampling" type="Bool">
+            <default>true</default>
+        </entry>
     </group>
 </kcfg>
diff --git a/effects/cube/cube_config.ui b/effects/cube/cube_config.ui
index ec79f1c59..05c04b604 100644
--- a/effects/cube/cube_config.ui
+++ b/effects/cube/cube_config.ui
@@ -14,7 +14,7 @@
    <item>
     <widget class="QTabWidget" name="tabWidget">
      <property name="currentIndex">
-      <number>0</number>
+      <number>1</number>
      </property>
      <widget class="QWidget" name="tab">
       <attribute name="title">
@@ -30,7 +30,7 @@
           <item row="0" column="0">
            <widget class="QLabel" name="label_6">
             <property name="text">
-             <string>Background color:</string>
+             <string>&amp;Background color:</string>
             </property>
             <property name="alignment">
              <set>Qt::AlignRight|Qt::AlignTrailing|Qt::AlignVCenter</set>
@@ -53,7 +53,7 @@
           <item row="1" column="0">
            <widget class="QLabel" name="label_3">
             <property name="text">
-             <string>Wallpaper:</string>
+             <string>Wa&amp;llpaper:</string>
             </property>
             <property name="alignment">
              <set>Qt::AlignRight|Qt::AlignTrailing|Qt::AlignVCenter</set>
@@ -83,16 +83,13 @@
          </property>
          <layout class="QGridLayout" name="gridLayout_3">
           <item row="0" column="0" colspan="2">
-           <widget class="KShortcutsEditor" name="editor" native="true">
+           <widget class="KShortcutsEditor" name="editor">
             <property name="minimumSize">
              <size>
               <width>0</width>
               <height>200</height>
              </size>
             </property>
-            <property name="actionTypes">
-              <enum>KShortcutsEditor::GlobalAction</enum>
-            </property>
            </widget>
           </item>
          </layout>
@@ -121,7 +118,7 @@
           <item row="3" column="0">
            <widget class="QLabel" name="label">
             <property name="text">
-             <string>Rotation duration:</string>
+             <string>Rotat&amp;ion duration:</string>
             </property>
             <property name="alignment">
              <set>Qt::AlignRight|Qt::AlignTrailing|Qt::AlignVCenter</set>
@@ -295,7 +292,7 @@
           <item row="1" column="0">
            <widget class="QLabel" name="capColorLabel">
             <property name="text">
-             <string>Cap color:</string>
+             <string>Cap co&amp;lor:</string>
             </property>
             <property name="alignment">
              <set>Qt::AlignRight|Qt::AlignTrailing|Qt::AlignVCenter</set>
@@ -440,6 +437,13 @@ otherwise it will remain active</string>
             </property>
            </widget>
           </item>
+          <item>
+           <widget class="QCheckBox" name="kcfg_Multisampling">
+            <property name="text">
+             <string>Use multisampling</string>
+            </property>
+           </widget>
+          </item>
          </layout>
         </widget>
        </item>
@@ -493,21 +497,21 @@ otherwise it will remain active</string>
  </widget>
  <customwidgets>
   <customwidget>
-   <class>KColorButton</class>
-   <extends>QPushButton</extends>
-   <header>kcolorbutton.h</header>
+   <class>KShortcutsEditor</class>
+   <extends>QWidget</extends>
+   <header>kshortcutseditor.h</header>
+   <container>1</container>
   </customwidget>
   <customwidget>
    <class>KUrlRequester</class>
-   <extends>QFrame</extends>
+   <extends>QWidget</extends>
    <header>kurlrequester.h</header>
    <container>1</container>
   </customwidget>
   <customwidget>
-   <class>KShortcutsEditor</class>
-   <extends>QWidget</extends>
-   <header location="global">KShortcutsEditor</header>
-   <container>1</container>
+   <class>KColorButton</class>
+   <extends>QPushButton</extends>
+   <header>kcolorbutton.h</header>
   </customwidget>
  </customwidgets>
  <tabstops>
diff --git a/effects/cube/cubeslide.cpp b/effects/cube/cubeslide.cpp
index 3d4db3151..be1631dfd 100644
--- a/effects/cube/cubeslide.cpp
+++ b/effects/cube/cubeslide.cpp
@@ -64,12 +64,16 @@ void CubeSlideEffect::reconfigure(ReconfigureFlags)
     dontSlideStickyWindows = CubeSlideConfig::dontSlideStickyWindows();
     usePagerLayout = CubeSlideConfig::usePagerLayout();
     useWindowMoving = CubeSlideConfig::useWindowMoving();
+    multisampling = CubeSlideConfig::multisampling();
 }
 
 void CubeSlideEffect::prePaintScreen(ScreenPrePaintData& data, int time)
 {
     if (!slideRotations.empty()) {
         data.mask |= PAINT_SCREEN_TRANSFORMED | Effect::PAINT_SCREEN_WITH_TRANSFORMED_WINDOWS | PAINT_SCREEN_BACKGROUND_FIRST;
+        if (multisampling) {
+            data.mask |= PAINT_SCREEN_MULTISAMPLE;
+        }
         timeLine.setCurrentTime(timeLine.currentTime() + time);
         if (windowMoving && timeLine.currentTime() > progressRestriction * (qreal)timeLine.duration())
             timeLine.setCurrentTime(progressRestriction * (qreal)timeLine.duration());
diff --git a/effects/cube/cubeslide.h b/effects/cube/cubeslide.h
index 92369f18a..493ae151c 100644
--- a/effects/cube/cubeslide.h
+++ b/effects/cube/cubeslide.h
@@ -102,6 +102,7 @@ private:
     bool windowMoving;
     bool desktopChangedWhileMoving;
     double progressRestriction;
+    bool multisampling;
 };
 }
 
diff --git a/effects/cube/cubeslide.kcfg b/effects/cube/cubeslide.kcfg
index 3a6f2cbd8..4e132a3c5 100644
--- a/effects/cube/cubeslide.kcfg
+++ b/effects/cube/cubeslide.kcfg
@@ -21,5 +21,8 @@
         <entry name="UseWindowMoving" type="Bool">
             <default>false</default>
         </entry>
+        <entry name="Multisampling" type="Bool">
+            <default>true</default>
+        </entry>
     </group>
 </kcfg>
diff --git a/effects/cube/cubeslide_config.ui b/effects/cube/cubeslide_config.ui
index 44acfe9ad..077670ff0 100644
--- a/effects/cube/cubeslide_config.ui
+++ b/effects/cube/cubeslide_config.ui
@@ -18,7 +18,7 @@
      </property>
     </widget>
    </item>
-   <item row="5" column="0">
+   <item row="6" column="0">
     <spacer name="verticalSpacer">
      <property name="orientation">
       <enum>Qt::Vertical</enum>
@@ -69,7 +69,7 @@
    <item row="0" column="0">
     <widget class="QLabel" name="label">
      <property name="text">
-      <string>Rotation duration:</string>
+      <string>Ro&amp;tation duration:</string>
      </property>
      <property name="alignment">
       <set>Qt::AlignRight|Qt::AlignTrailing|Qt::AlignVCenter</set>
@@ -93,6 +93,13 @@
      </property>
     </widget>
    </item>
+   <item row="5" column="0">
+    <widget class="QCheckBox" name="kcfg_Multisampling">
+     <property name="text">
+      <string>Use multisampling</string>
+     </property>
+    </widget>
+   </item>
   </layout>
  </widget>
  <tabstops>
diff --git a/effects/flipswitch/flipswitch.cpp b/effects/flipswitch/flipswitch.cpp
index 533797946..f030abe54 100644
--- a/effects/flipswitch/flipswitch.cpp
+++ b/effects/flipswitch/flipswitch.cpp
@@ -101,12 +101,16 @@ void FlipSwitchEffect::reconfigure(ReconfigureFlags)
     m_xPosition = FlipSwitchConfig::xPosition() / 100.0f;
     m_yPosition = FlipSwitchConfig::yPosition() / 100.0f;
     m_windowTitle = FlipSwitchConfig::windowTitle();
+    m_multisampling = FlipSwitchConfig::multisampling();
 }
 
 void FlipSwitchEffect::prePaintScreen(ScreenPrePaintData& data, int time)
 {
     if (m_active) {
         data.mask |= PAINT_SCREEN_WITH_TRANSFORMED_WINDOWS;
+        if (m_multisampling) {
+            data.mask |= PAINT_SCREEN_MULTISAMPLE;
+        }
         if (m_start)
             m_startStopTimeLine.setCurrentTime(m_startStopTimeLine.currentTime() + time);
         if (m_stop && m_scheduledDirections.isEmpty())
diff --git a/effects/flipswitch/flipswitch.h b/effects/flipswitch/flipswitch.h
index add05b4ff..372f6f310 100644
--- a/effects/flipswitch/flipswitch.h
+++ b/effects/flipswitch/flipswitch.h
@@ -144,6 +144,7 @@ private:
     float m_xPosition;
     float m_yPosition;
     bool m_windowTitle;
+    bool m_multisampling;
     // Shortcuts
     QList<QKeySequence> m_shortcutCurrent;
     QList<QKeySequence> m_shortcutAll;
diff --git a/effects/flipswitch/flipswitch.kcfg b/effects/flipswitch/flipswitch.kcfg
index 37c2e7599..1e436a58c 100644
--- a/effects/flipswitch/flipswitch.kcfg
+++ b/effects/flipswitch/flipswitch.kcfg
@@ -26,5 +26,8 @@
         <entry name="WindowTitle" type="Bool">
             <default>true</default>
         </entry>
+        <entry name="Multisampling" type="Bool">
+            <default>true</default>
+        </entry>
     </group>
 </kcfg>
diff --git a/effects/flipswitch/flipswitch_config.ui b/effects/flipswitch/flipswitch_config.ui
index 02a925f6b..05c9d93a3 100644
--- a/effects/flipswitch/flipswitch_config.ui
+++ b/effects/flipswitch/flipswitch_config.ui
@@ -7,7 +7,7 @@
     <x>0</x>
     <y>0</y>
     <width>400</width>
-    <height>316</height>
+    <height>400</height>
    </rect>
   </property>
   <layout class="QVBoxLayout">
@@ -20,7 +20,7 @@
       <item row="0" column="0">
        <widget class="QLabel" name="label_3">
         <property name="text">
-         <string>Flip animation duration:</string>
+         <string>&amp;Flip animation duration:</string>
         </property>
         <property name="alignment">
          <set>Qt::AlignRight|Qt::AlignTrailing|Qt::AlignVCenter</set>
@@ -52,7 +52,7 @@
       <item row="1" column="0">
        <widget class="QLabel" name="label">
         <property name="text">
-         <string>Angle:</string>
+         <string>A&amp;ngle:</string>
         </property>
         <property name="buddy">
          <cstring>kcfg_Angle</cstring>
@@ -75,17 +75,17 @@
         </property>
        </widget>
       </item>
-      <item row="3" column="0">
+      <item row="4" column="0">
        <widget class="QLabel" name="label_2">
         <property name="text">
-         <string>Horizontal position of front:</string>
+         <string>&amp;Horizontal position of front:</string>
         </property>
         <property name="buddy">
          <cstring>kcfg_XPosition</cstring>
         </property>
        </widget>
       </item>
-      <item row="3" column="1">
+      <item row="4" column="1">
        <layout class="QVBoxLayout" name="verticalLayout_2">
         <item>
          <widget class="QSlider" name="kcfg_XPosition">
@@ -130,17 +130,17 @@
         </item>
        </layout>
       </item>
-      <item row="7" column="0">
+      <item row="8" column="0">
        <widget class="QLabel" name="label_6">
         <property name="text">
-         <string>Vertical position of front:</string>
+         <string>&amp;Vertical position of front:</string>
         </property>
         <property name="buddy">
          <cstring>kcfg_YPosition</cstring>
         </property>
        </widget>
       </item>
-      <item row="7" column="1">
+      <item row="8" column="1">
        <layout class="QHBoxLayout" name="horizontalLayout_2">
         <item>
          <widget class="QSlider" name="kcfg_YPosition">
@@ -195,6 +195,13 @@
         </property>
        </widget>
       </item>
+      <item row="3" column="0" colspan="2">
+       <widget class="QCheckBox" name="kcfg_Multisampling">
+        <property name="text">
+         <string>Use multisampling</string>
+        </property>
+       </widget>
+      </item>
      </layout>
     </widget>
    </item>
@@ -205,16 +212,13 @@
      </property>
      <layout class="QGridLayout" name="gridLayout_2">
       <item row="0" column="0" colspan="2">
-       <widget class="KShortcutsEditor" name="shortcutEditor" native="true">
+       <widget class="KShortcutsEditor" name="shortcutEditor">
         <property name="sizePolicy">
          <sizepolicy hsizetype="Preferred" vsizetype="Preferred">
           <horstretch>0</horstretch>
           <verstretch>0</verstretch>
          </sizepolicy>
         </property>
-        <property name="actionTypes">
-            <enum>KShortcutsEditor::GlobalAction</enum>
-        </property>
        </widget>
       </item>
      </layout>
@@ -226,7 +230,7 @@
   <customwidget>
    <class>KShortcutsEditor</class>
    <extends>QWidget</extends>
-   <header location="global">KShortcutsEditor</header>
+   <header>kshortcutseditor.h</header>
    <container>1</container>
   </customwidget>
  </customwidgets>
diff --git a/effects/magiclamp/magiclamp.cpp b/effects/magiclamp/magiclamp.cpp
index a392d4942..62f55df50 100644
--- a/effects/magiclamp/magiclamp.cpp
+++ b/effects/magiclamp/magiclamp.cpp
@@ -52,6 +52,7 @@ void MagicLampEffect::reconfigure(ReconfigureFlags)
     MagicLampConfig::self()->read();
     // TODO: rename animationDuration to duration
     mAnimationDuration = animationTime(MagicLampConfig::animationDuration() != 0 ? MagicLampConfig::animationDuration() : 250);
+    mMultisampling = MagicLampConfig::multisampling();
 }
 
 void MagicLampEffect::prePaintScreen(ScreenPrePaintData& data, int time)
@@ -76,10 +77,14 @@ void MagicLampEffect::prePaintScreen(ScreenPrePaintData& data, int time)
     }
 
     mActiveAnimations = mTimeLineWindows.count();
-    if (mActiveAnimations > 0)
+    if (mActiveAnimations > 0) {
         // We need to mark the screen windows as transformed. Otherwise the
         //  whole screen won't be repainted, resulting in artefacts
         data.mask |= PAINT_SCREEN_WITH_TRANSFORMED_WINDOWS;
+        if (mMultisampling) {
+            data.mask |= PAINT_SCREEN_MULTISAMPLE;
+        }
+    }
 
     effects->prePaintScreen(data, time);
 }
diff --git a/effects/magiclamp/magiclamp.h b/effects/magiclamp/magiclamp.h
index 95865d4c1..8243cd50b 100644
--- a/effects/magiclamp/magiclamp.h
+++ b/effects/magiclamp/magiclamp.h
@@ -62,6 +62,7 @@ private:
     QHash< EffectWindow*, QTimeLine* > mTimeLineWindows;
     int mActiveAnimations;
     int mAnimationDuration;
+    bool mMultisampling;
 
     enum IconPosition {
         Top,
diff --git a/effects/magiclamp/magiclamp.kcfg b/effects/magiclamp/magiclamp.kcfg
index 67c8ba0c1..80cd96786 100644
--- a/effects/magiclamp/magiclamp.kcfg
+++ b/effects/magiclamp/magiclamp.kcfg
@@ -8,5 +8,8 @@
         <entry name="AnimationDuration" type="Int">
             <default>0</default>
         </entry>
+        <entry name="Multisampling" type="Bool">
+            <default>true</default>
+        </entry>
     </group>
 </kcfg>
diff --git a/effects/magiclamp/magiclamp_config.ui b/effects/magiclamp/magiclamp_config.ui
index 9e1063ac6..ba589e9ec 100644
--- a/effects/magiclamp/magiclamp_config.ui
+++ b/effects/magiclamp/magiclamp_config.ui
@@ -6,45 +6,69 @@
    <rect>
     <x>0</x>
     <y>0</y>
-    <width>400</width>
-    <height>300</height>
+    <width>383</width>
+    <height>191</height>
    </rect>
   </property>
-  <layout class="QFormLayout" name="formLayout">
-   <item row="0" column="0">
-    <widget class="QLabel" name="label_3">
+  <layout class="QVBoxLayout" name="verticalLayout">
+   <item>
+    <layout class="QHBoxLayout" name="horizontalLayout">
+     <item>
+      <widget class="QLabel" name="label_3">
+       <property name="text">
+        <string>A&amp;nimation duration:</string>
+       </property>
+       <property name="alignment">
+        <set>Qt::AlignRight|Qt::AlignTrailing|Qt::AlignVCenter</set>
+       </property>
+       <property name="buddy">
+        <cstring>kcfg_AnimationDuration</cstring>
+       </property>
+      </widget>
+     </item>
+     <item>
+      <widget class="QSpinBox" name="kcfg_AnimationDuration">
+       <property name="sizePolicy">
+        <sizepolicy hsizetype="Expanding" vsizetype="Fixed">
+         <horstretch>0</horstretch>
+         <verstretch>0</verstretch>
+        </sizepolicy>
+       </property>
+       <property name="specialValueText">
+        <string comment="Duration of rotation">Default</string>
+       </property>
+       <property name="suffix">
+        <string>milliseconds</string>
+       </property>
+       <property name="maximum">
+        <number>5000</number>
+       </property>
+       <property name="singleStep">
+        <number>10</number>
+       </property>
+      </widget>
+     </item>
+    </layout>
+   </item>
+   <item>
+    <widget class="QCheckBox" name="kcfg_Multisampling">
      <property name="text">
-      <string>Animation duration:</string>
-     </property>
-     <property name="alignment">
-      <set>Qt::AlignRight|Qt::AlignTrailing|Qt::AlignVCenter</set>
-     </property>
-     <property name="buddy">
-      <cstring>kcfg_AnimationDuration</cstring>
+      <string>Use multisampling</string>
      </property>
     </widget>
    </item>
-   <item row="0" column="1">
-    <widget class="QSpinBox" name="kcfg_AnimationDuration">
-     <property name="sizePolicy">
-      <sizepolicy hsizetype="Expanding" vsizetype="Fixed">
-       <horstretch>0</horstretch>
-       <verstretch>0</verstretch>
-      </sizepolicy>
-     </property>
-     <property name="specialValueText">
-      <string comment="Duration of rotation">Default</string>
+   <item>
+    <spacer name="verticalSpacer">
+     <property name="orientation">
+      <enum>Qt::Vertical</enum>
      </property>
-     <property name="suffix">
-      <string>milliseconds</string>
+     <property name="sizeHint" stdset="0">
+      <size>
+       <width>20</width>
+       <height>40</height>
+      </size>
      </property>
-     <property name="maximum">
-      <number>5000</number>
-     </property>
-     <property name="singleStep">
-      <number>10</number>
-     </property>
-    </widget>
+    </spacer>
    </item>
   </layout>
  </widget>
diff --git a/libkwineffects/kwineffects.h b/libkwineffects/kwineffects.h
index 04e77aa1f..ee076576b 100644
--- a/libkwineffects/kwineffects.h
+++ b/libkwineffects/kwineffects.h
@@ -352,8 +352,12 @@ public:
         /**
          * Window will be painted with a lanczos filter.
          **/
-        PAINT_WINDOW_LANCZOS = 1 << 8
+        PAINT_WINDOW_LANCZOS = 1 << 8,
         // PAINT_SCREEN_WITH_TRANSFORMED_WINDOWS_WITHOUT_FULL_REPAINTS = 1 << 9 has been removed
+        /**
+         * Use multisampling.
+         **/
+        PAINT_SCREEN_MULTISAMPLE = 1 << 10
     };
 
     enum Feature {
-- 
2.17.0

