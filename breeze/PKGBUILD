# Maintainer: Vlad Zagorodniy <vladzzag@gmail.com>
# Copied from arch repos.

pkgbase=breeze
pkgname=(breeze breeze-kde4)
pkgver=5.13.4
pkgrel=2
arch=(x86_64)
url='https://www.kde.org/workspaces/plasmadesktop/'
license=(LGPL)
makedepends=(automoc4 breeze-icons fftw frameworkintegration extra-cmake-modules
             kcmutils kdecoration kdelibs plasma-framework python)
source=("https://download.kde.org/stable/plasma/$pkgver/$pkgbase-$pkgver.tar.xz"{,.sig}
        reserve-space-for-checkable-widgets-on-the-left-side.patch
        libbreezecommon-add-box-shadow-helper.patch
        kdecoration-refine-shadows.patch
        kstyle-refine-shadows.patch
        0001-kdecoration-Make-shadows-lighter.patch
        0001-Rename-libbreezecommon-to-libbreezecommon5-and-don-t.patch
        0001-kstyle-Create-shadow-tiles-on-demand.patch)
sha256sums=('04e157d3468a85190cb7c8acff09c382830d9c15fc53200394359d393f6aaccf'
            'SKIP'
            '4419b2042c131666e27bef4b1ea48c1027fbedb176755263d272a71d1539bd35'
            '52f5cf7fdf457a602ba25b0e972ea238ce0c028446fd2e35760413a360e2e86f'
            '26178e1d27ec94dee26f786df4883364e243f483c5d55a8c148f32a1060eb909'
            '1e2029bc32aa2ec6f7a099e887ce9a933c90eeae98b49c5a08d0824a46582924'
            'a281cb084c19c877be61db8091dada936771b237a8ad6f7a15857c78791ca91b'
            '4a8cd5e2fe1453aab22a6302ddf238f613de7ee6a977e065914b9e9d96d5e600'
            'e78fc98aec1d3d22b282d4865496572b8598d3760b77f0836fa2ed6bcb0f967a')
validpgpkeys=('2D1D5B0588357787DE9EE225EC94D18F7F05997E'  # Jonathan Riddell <jr@jriddell.org>
              '0AAC775BB6437A8D9AF7A3ACFE0784117FBCE11D') # Bhushan Shah <bshah@kde.org>

prepare() {
  mkdir -p build{,-kde4}

  cd $pkgbase-$pkgver
  patch -Np1 < "$srcdir/reserve-space-for-checkable-widgets-on-the-left-side.patch"
  patch -Np1 < "$srcdir/libbreezecommon-add-box-shadow-helper.patch"
  patch -Np1 < "$srcdir/kdecoration-refine-shadows.patch"
  patch -Np1 < "$srcdir/kstyle-refine-shadows.patch"
  patch -Np1 < "$srcdir/0001-kdecoration-Make-shadows-lighter.patch"
  patch -Np1 < "$srcdir/0001-Rename-libbreezecommon-to-libbreezecommon5-and-don-t.patch"
  patch -Np1 < "$srcdir/0001-kstyle-Create-shadow-tiles-on-demand.patch"
}

build() {
  cd build
  cmake ../$pkgbase-$pkgver \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_INSTALL_LIBDIR=lib \
    -DBUILD_TESTING=OFF
  make

  cd ../build-kde4
  cmake ../$pkgbase-$pkgver \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DUSE_KDE4=ON \
    -DBUILD_TESTING=OFF
  make
}

package_breeze() {
  depends=(frameworkintegration kdecoration breeze-icons kwayland hicolor-icon-theme fftw)
  pkgdesc='Artwork, styles and assets for the Breeze visual style for the Plasma Desktop'
  optdepends=('breeze-kde4: Breeze widget style for KDE4 applications'
              'breeze-gtk: Breeze widget style for GTK applications'
              'kcmutils: for breeze-settings')
  groups=(plasma)

  cd build
  make DESTDIR="$pkgdir" install
}

package_breeze-kde4() {
  pkgdesc='Breeze widget style for KDE4 applications'
  depends=(kdelibs fftw)

  cd build-kde4
  make DESTDIR="$pkgdir" install

  # needed for pure Qt4 apps
  install -d "$pkgdir"/usr/lib/qt4/plugins/styles
  ln -s /usr/lib/kde4/plugins/styles/breeze.so "$pkgdir"/usr/lib/qt4/plugins/styles
}
